<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard | Gospel Springs Ministry</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3a5a78;
            --primary-light: #4a6fa5;
            --secondary: #1a3a5a;
            --accent: #5cb3ff;
            --light: #f8fafc;
            --dark: #1e293b;
            --success: #10b981;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .greeting-container {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }

        .greeting {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .greeting-text {
            opacity: 0.9;
        }

        /* Profile Section */
        .profile-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .profile-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            margin-right: 1.5rem;
        }

        .profile-info h2 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .profile-info p {
            color: var(--secondary);
            font-weight: 500;
        }

        /* Member Details */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .detail-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary);
            border-bottom: 1px solid var(--light);
            padding-bottom: 0.5rem;
        }

        .detail-item {
            margin-bottom: 1rem;
        }

        .detail-item h3 {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item p {
            font-weight: 500;
            padding: 0.5rem;
            background: var(--light);
            border-radius: 6px;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-avatar {
                margin-right: 0;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Dashboard Header with Greeting -->
        <div class="dashboard-header">
            <div class="greeting-container">
                <h1 class="greeting" id="greetingText">Hello, <span id="userFirstName">Member</span></h1>
                <p class="greeting-text" id="greetingTime">Welcome to your member dashboard</p>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
        </div>

        <!-- Profile Section -->
        <div class="profile-section" id="profileSection" style="display: none;">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">M</div>
                    <div class="profile-info">
                        <h2 id="userName">Loading...</h2>
                        <p id="userRole">Member</p>
                    </div>
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <h3>Member ID</h3>
                        <p id="memberId">GSM-0000</p>
                    </div>
                    <div class="detail-item">
                        <h3>Email</h3>
                        <p id="userEmail">user@example.com</p>
                    </div>
                    <div class="detail-item">
                        <h3>Phone</h3>
                        <p id="userPhone">+1234567890</p>
                    </div>
                    <div class="detail-item">
                        <h3>Membership Date</h3>
                        <p id="membershipDate">January 1, 2023</p>
                    </div>
                </div>
            </div>

            <div class="profile-card">
                <h2>Contact Information</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <h3>Address</h3>
                        <p id="userAddress">123 Church Street, City</p>
                    </div>
                    <div class="detail-item">
                        <h3>City</h3>
                        <p id="userCity">City</p>
                    </div>
                    <div class="detail-item">
                        <h3>State/Region</h3>
                        <p id="userState">State</p>
                    </div>
                    <div class="detail-item">
                        <h3>Country</h3>
                        <p id="userCountry">Country</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Member Details Section -->
        <div class="detail-card" id="memberDetails" style="display: none;">
            <h2>Member Details</h2>
            <div class="details-grid" id="memberDetailsGrid">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs - First Project (Authentication) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp as initializeApp1 } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // First Firebase project configuration (Web App)
        const firebaseConfig1 = {
            apiKey: "AIzaSyDJJqxh3UOsTcBPAXLeEWeLoQRmIy_6hNU",
            authDomain: "web-app-ae5b6.firebaseapp.com",
            projectId: "web-app-ae5b6",
            storageBucket: "web-app-ae5b6.appspot.com",
            messagingSenderId: "921251501161",
            appId: "1:921251501161:web:316ff3fc4345735762bef8"
        };

        // Second Firebase project configuration (Church CMS)
        const firebaseConfig2 = {
            apiKey: "AIzaSyAyiRtkvdxnGWaiG-Xn-50Vm_Pb1J0ya6E",
            authDomain: "church-cms-96407.firebaseapp.com",
            projectId: "church-cms-96407",
            storageBucket: "church-cms-96407.appspot.com",
            messagingSenderId: "19370427001",
            appId: "1:19370427001:web:b1d20215c437fc324e4aa8",
            measurementId: "G-NKDZSFGR4X"
        };

        // Initialize both Firebase apps
        const app1 = initializeApp1(firebaseConfig1, "app1");
        const app2 = initializeApp1(firebaseConfig2, "app2");

        // Get auth and firestore instances
        const auth = getAuth(app1);
        const db1 = getFirestore(app1);
        const db2 = getFirestore(app2);

        // DOM Elements
        const greetingText = document.getElementById('greetingText');
        const userFirstName = document.getElementById('userFirstName');
        const greetingTime = document.getElementById('greetingTime');
        const profileAvatar = document.getElementById('profileAvatar');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const memberId = document.getElementById('memberId');
        const userEmail = document.getElementById('userEmail');
        const userPhone = document.getElementById('userPhone');
        const membershipDate = document.getElementById('membershipDate');
        const userAddress = document.getElementById('userAddress');
        const userCity = document.getElementById('userCity');
        const userState = document.getElementById('userState');
        const userCountry = document.getElementById('userCountry');
        const memberDetailsGrid = document.getElementById('memberDetailsGrid');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const profileSection = document.getElementById('profileSection');
        const memberDetails = document.getElementById('memberDetails');

        // Set greeting based on time of day
        function setGreeting(firstName) {
            const hour = new Date().getHours();
            let timeGreeting;
            
            if (hour < 12) {
                timeGreeting = "Good Morning";
            } else if (hour < 18) {
                timeGreeting = "Good Afternoon";
            } else {
                timeGreeting = "Good Evening";
            }
            
            greetingTime.textContent = timeGreeting;
            userFirstName.textContent = firstName || "Member";
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return "Not available";
            
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            try {
                const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
                return isNaN(date.getTime()) ? "Not available" : date.toLocaleDateString('en-US', options);
            } catch (e) {
                return "Not available";
            }
        }

        // Display all member data in a structured way
        function displayMemberData(memberData) {
            // Clear previous content
            memberDetailsGrid.innerHTML = '';

            // Loop through all properties in memberData
            for (const [key, value] of Object.entries(memberData)) {
                // Skip these as they're already displayed in the profile section
                if (['firstName', 'lastName', 'email', 'phone', 'address', 'city', 'state', 'country', 'memberId', 'membershipDate'].includes(key)) {
                    continue;
                }

                // Skip if value is empty or null
                if (!value && value !== 0 && value !== false) continue;

                // Create detail item
                const detailItem = document.createElement('div');
                detailItem.className = 'detail-item';

                // Format the key for display
                const formattedKey = key
                    .replace(/([A-Z])/g, ' $1')
                    .replace(/^./, str => str.toUpperCase())
                    .replace(/_/g, ' ');

                let displayValue = value;

                // Special formatting for certain field types
                if (typeof value === 'boolean') {
                    displayValue = value ? 'Yes' : 'No';
                } else if (key.toLowerCase().includes('date')) {
                    displayValue = formatDate(value);
                } else if (typeof value === 'object' && value !== null) {
                    displayValue = JSON.stringify(value, null, 2);
                }

                detailItem.innerHTML = `
                    <h3>${formattedKey}</h3>
                    <p>${displayValue}</p>
                `;

                memberDetailsGrid.appendChild(detailItem);
            }

            // Show the member details section
            memberDetails.style.display = 'block';
        }

        // Fetch member data from second Firebase project
        async function fetchMemberData(email) {
            try {
                // Query members collection in second Firebase project
                const membersRef = collection(db2, 'members');
                const q = query(membersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const memberDoc = querySnapshot.docs[0];
                    return memberDoc.data();
                } else {
                    console.log("No member data found in church-cms database");
                    return null;
                }
            } catch (error) {
                console.error("Error fetching member data:", error);
                return null;
            }
        }

        // Fetch user data from first Firebase project
        async function fetchUserData(user) {
            try {
                // Query useraccount collection in first Firebase project
                const usersRef = collection(db1, 'useraccount');
                const q = query(usersRef, where("email", "==", user.email));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    return userDoc.data();
                } else {
                    console.log("No user data found in web-app database");
                    return null;
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                return null;
            }
        }

        // Authentication state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in to first Firebase project
                try {
                    // Fetch basic user data from first project
                    const userData = await fetchUserData(user);
                    
                    // Fetch detailed member data from second project
                    const memberData = await fetchMemberData(user.email);

                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    profileSection.style.display = 'grid';

                    // Set greeting with first name
                    const firstName = memberData?.firstName || userData?.firstName || '';
                    setGreeting(firstName);

                    // Update profile information
                    if (memberData || userData) {
                        const data = memberData || userData;

                        // Profile avatar with first initial
                        profileAvatar.textContent = data.firstName ? data.firstName.charAt(0).toUpperCase() : 'M';

                        // User name
                        const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim();
                        userName.textContent = fullName || 'Member';

                        // Member ID (from first project)
                        memberId.textContent = userData?.memberId || 'GSM-0000';

                        // Email
                        userEmail.textContent = user.email || "Not provided";

                        // Other details from member data
                        if (memberData) {
                            userRole.textContent = memberData.role || "Member";
                            userPhone.textContent = memberData.phone || "Not provided";
                            membershipDate.textContent = formatDate(memberData.membershipDate || memberData.createdAt);
                            userAddress.textContent = memberData.address || "Not provided";
                            userCity.textContent = memberData.city || "Not provided";
                            userState.textContent = memberData.state || "Not provided";
                            userCountry.textContent = memberData.country || "Not provided";

                            // Display all other member data
                            displayMemberData(memberData);
                        } else {
                            // Fallback to user data if no member data
                            userPhone.textContent = userData?.phoneNumber || "Not provided";
                            membershipDate.textContent = formatDate(userData?.createdAt);
                        }
                    }
                } catch (error) {
                    console.error("Error processing user data:", error);
                    // Handle error (could show error message to user)
                }
            } else {
                // User is signed out, redirect to login
                window.location.href = 'Login.html';
            }
        });
    </script>
</body>
</html>
