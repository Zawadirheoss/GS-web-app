<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gospel Springs Community</title>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #25D366;
            --secondary-color: #128C7E;
            --bg-color: #e5ddd5;
            --chat-bg: #ffffff;
            --sender-bg: #dcf8c6;
            --receiver-bg: #ffffff;
            --text-color: #333;
            --timestamp-color: #999;
            --header-height: 60px;
            --input-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
        }

        .header {
            background-color: white;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .greeting {
            font-size: 14px;
            color: var(--text-color);
        }

        .profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }

        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 10px;
            display: none;
            min-width: 200px;
            z-index: 100;
        }

        .profile:hover .profile-dropdown {
            display: block;
        }

        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            background-color: #f0f2f5;
            font-weight: bold;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f2f5;
        }

        .user-item:hover {
            background-color: #f5f5f5;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
        }

        .user-email {
            font-size: 12px;
            color: var(--timestamp-color);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
            background-repeat: repeat;
            background-position: center;
        }

        .chat-header {
            padding: 15px;
            background-color: #f0f2f5;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--sender-bg);
            border-top-right-radius: 0;
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--receiver-bg);
            border-top-left-radius: 0;
        }

        .message-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .sender-name {
            font-weight: bold;
            font-size: 14px;
        }

        .timestamp {
            font-size: 11px;
            color: var(--timestamp-color);
            margin-left: 10px;
        }

        .message-content {
            font-size: 15px;
        }

        .reply-indicator {
            font-size: 12px;
            color: var(--secondary-color);
            border-left: 2px solid var(--secondary-color);
            padding-left: 8px;
            margin-bottom: 5px;
        }

        .input-area {
            padding: 10px;
            background-color: #f0f2f5;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 15px;
        }

        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background-color: var(--secondary-color);
        }

        .send-icon {
            font-size: 18px;
        }

        .no-messages {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--timestamp-color);
            font-size: 16px;
        }

        .message-actions {
            position: absolute;
            top: -25px;
            right: 0;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .action-button {
            padding: 5px;
            cursor: pointer;
            color: var(--text-color);
        }

        .action-button:hover {
            color: var(--secondary-color);
        }

        .deleted-message {
            font-style: italic;
            color: var(--timestamp-color);
        }

        .active-chat {
            background-color: #e5f5fb;
        }

        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .login-button {
            margin-top: 20px;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-button:hover {
            background-color: var(--secondary-color);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-left">
                <img src="Gospel springs logo.jpg" alt="Logo" class="logo">
                <h4>Gospel Springs Community</h4>
            </div>
            <div class="greeting" id="greeting"></div>
            <div class="profile" id="profile">
                <span id="profile-letter">U</span>
                <div class="profile-dropdown">
                    <div id="user-email">user@example.com</div>
                </div>
            </div>
        </header>

        <!-- Main Chat Container -->
        <div class="chat-container">
            <!-- Sidebar with Users -->
            <div class="sidebar">
                <div class="sidebar-header">Group Chat</div>
                <div class="user-list" id="group-chat-item">
                    <div class="user-item active-chat" id="group-chat">
                        <div class="user-avatar">GC</div>
                        <div class="user-info">
                            <div class="user-name">Group Chat</div>
                            <div class="user-email">Community messages</div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-header">Private Chats</div>
                <div class="user-list" id="user-list"></div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="chat-header" id="chat-header">Group Chat</div>
                <div class="messages" id="messages">
                    <div class="no-messages">No messages yet</div>
                </div>
                <div class="input-area">
                    <input type="text" class="message-input" id="message-input" placeholder="Type a message...">
                    <button class="send-button" id="send-button">
                        <span class="send-icon">→</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Container (shown when not authenticated) -->
    <div class="login-container hidden" id="login-container">
        <h2>Welcome to Gospel Springs Community</h2>
        <p>Please sign in to continue to the chat platform</p>
        <button class="login-button" id="login-button">Sign In with Google</button>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp,
            doc,
            deleteDoc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDJJqxh3UOsTcBPAXLeEWeLoQRmIy_6hNU",
            authDomain: "web-app-ae5b6.firebaseapp.com",
            projectId: "web-app-ae5b6",
            storageBucket: "web-app-ae5b6.firebasestorage.app",
            messagingSenderId: "921251501161",
            appId: "1:921251501161:web:316ff3fc4345735762bef8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const loginContainer = document.getElementById('login-container');
        const loginButton = document.getElementById('login-button');
        const greetingElement = document.getElementById('greeting');
        const profileElement = document.getElementById('profile');
        const profileLetter = document.getElementById('profile-letter');
        const userEmailElement = document.getElementById('user-email');
        const userList = document.getElementById('user-list');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatHeader = document.getElementById('chat-header');
        const groupChatItem = document.getElementById('group-chat-item');
        const groupChat = document.getElementById('group-chat');

        // Global variables
        let currentUser = null;
        let currentChat = 'group'; // 'group' or userId for private chat
        let selectedUser = null;
        let replyingToMessage = null;

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Login button
            loginButton.addEventListener('click', signInWithGoogle);
            
            // Send message
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Profile dropdown
            profileElement.addEventListener('click', () => {
                const dropdown = profileElement.querySelector('.profile-dropdown');
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });

            // Group chat selection
            groupChat.addEventListener('click', () => {
                currentChat = 'group';
                selectedUser = null;
                updateActiveChatUI();
                loadMessages();
            });
        }

        // Check authentication state
        function checkAuthState() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    setupUserUI();
                    loadUsers();
                    loadMessages();
                    appContainer.classList.remove('hidden');
                    loginContainer.classList.add('hidden');
                } else {
                    // User is signed out
                    appContainer.classList.add('hidden');
                    loginContainer.classList.remove('hidden');
                    // Redirect to login page if not authenticated
                    window.location.href = 'login.html';
                }
            });
        }

        // Sign in with Google
        function signInWithGoogle() {
            signInWithPopup(auth, provider)
                .then((result) => {
                    // User signed in
                    currentUser = result.user;
                    setupUserUI();
                    loadUsers();
                    loadMessages();
                    appContainer.classList.remove('hidden');
                    loginContainer.classList.add('hidden');
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                });
        }

        // Set up user UI
        function setupUserUI() {
            // Set profile letter
            profileLetter.textContent = currentUser.email[0].toUpperCase();
            
            // Set user email in dropdown
            userEmailElement.textContent = currentUser.email;
            
            // Set greeting based on time of day
            setGreeting();
        }

        // Set greeting message based on time
        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = '';
            
            if (hour < 12) {
                greeting = `Good morning, ${currentUser.email.split('@')[0]}`;
            } else if (hour < 18) {
                greeting = `Good afternoon, ${currentUser.email.split('@')[0]}`;
            } else {
                greeting = `Good evening, ${currentUser.email.split('@')[0]}`;
            }
            
            greetingElement.textContent = greeting;
        }

        // Load all users except current user
        function loadUsers() {
            // In a real app, you would query your users collection
            // For this example, we'll simulate it with auth users
            
            // Clear existing users
            userList.innerHTML = '';
            
            // Add a listener for all users (in a real app, you'd have a users collection)
            // This is a simplified version
            onSnapshot(collection(db, 'users'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const user = change.doc.data();
                        if (user.uid !== currentUser.uid) {
                            addUserToSidebar(user);
                        }
                    }
                });
            });
            
            // For demo purposes, we'll just show a few simulated users
            const demoUsers = [
                { uid: 'user2', email: 'user2@example.com', displayName: 'User Two' },
                { uid: 'user3', email: 'user3@example.com', displayName: 'User Three' },
                { uid: 'user4', email: 'user4@example.com', displayName: 'User Four' }
            ];
            
            demoUsers.forEach(user => {
                if (user.uid !== currentUser.uid) {
                    addUserToSidebar(user);
                }
            });
        }

        // Add user to sidebar
        function addUserToSidebar(user) {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.dataset.userId = user.uid;
            
            userItem.innerHTML = `
                <div class="user-avatar">${user.email[0].toUpperCase()}</div>
                <div class="user-info">
                    <div class="user-name">${user.displayName || user.email.split('@')[0]}</div>
                    <div class="user-email">${user.email}</div>
                </div>
            `;
            
            userItem.addEventListener('click', () => {
                currentChat = user.uid;
                selectedUser = user;
                updateActiveChatUI();
                loadMessages();
            });
            
            userList.appendChild(userItem);
        }

        // Update active chat UI
        function updateActiveChatUI() {
            // Remove active class from all items
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active-chat');
            });
            
            // Add active class to selected item
            if (currentChat === 'group') {
                groupChat.classList.add('active-chat');
                chatHeader.textContent = 'Group Chat';
            } else {
                document.querySelector(`.user-item[data-user-id="${currentChat}"]`).classList.add('active-chat');
                chatHeader.textContent = selectedUser.displayName || selectedUser.email.split('@')[0];
            }
        }

        // Load messages for current chat
        function loadMessages() {
            // Clear messages container
            messagesContainer.innerHTML = '';
            
            if (currentChat === 'group') {
                // Load group messages
                loadGroupMessages();
            } else {
                // Load private messages
                loadPrivateMessages();
            }
        }

        // Load group messages
        function loadGroupMessages() {
            const messagesQuery = query(
                collection(db, 'conversations', 'group', 'messages'),
                where('createdAt', '>=', currentUser.metadata.creationTime)
            );
            
            onSnapshot(messagesQuery, (snapshot) => {
                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<div class="no-messages">No messages yet</div>';
                    return;
                }
                
                messagesContainer.innerHTML = '';
                
                snapshot.docs.forEach(doc => {
                    const message = doc.data();
                    displayMessage(message, doc.id);
                });
                
                scrollToBottom();
            });
        }

        // Load private messages
        function loadPrivateMessages() {
            // Determine the conversation ID (sorted user IDs)
            const conversationId = [currentUser.uid, currentChat].sort().join('_');
            
            const messagesQuery = query(
                collection(db, 'conversations', conversationId, 'messages')
            );
            
            onSnapshot(messagesQuery, (snapshot) => {
                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<div class="no-messages">No messages yet. Start a conversation!</div>';
                    return;
                }
                
                messagesContainer.innerHTML = '';
                
                snapshot.docs.forEach(doc => {
                    const message = doc.data();
                    displayMessage(message, doc.id);
                });
                
                scrollToBottom();
            });
        }

        // Display a message in the chat
        function displayMessage(message, messageId) {
            // Check if message is deleted
            if (message.deleted) {
                const deletedMessage = document.createElement('div');
                deletedMessage.className = message.senderId === currentUser.uid ? 'message sent' : 'message received';
                deletedMessage.innerHTML = `
                    <div class="message-content deleted-message">This message was deleted</div>
                    <div class="timestamp">${formatTimestamp(message.timestamp)}</div>
                `;
                messagesContainer.appendChild(deletedMessage);
                return;
            }
            
            const isSent = message.senderId === currentUser.uid;
            const messageElement = document.createElement('div');
            messageElement.className = isSent ? 'message sent' : 'message received';
            
            // Check if this is a reply
            let replyContent = '';
            if (message.replyTo) {
                const repliedMessage = message.replyTo;
                replyContent = `
                    <div class="reply-indicator">
                        Replying to ${repliedMessage.senderId === currentUser.uid ? 'yourself' : repliedMessage.senderEmail.split('@')[0]}: 
                        ${repliedMessage.content.substring(0, 30)}${repliedMessage.content.length > 30 ? '...' : ''}
                    </div>
                `;
            }
            
            messageElement.innerHTML = `
                <div class="message-info">
                    <span class="sender-name">${isSent ? 'You' : message.senderEmail.split('@')[0]}</span>
                    <span class="timestamp">${formatTimestamp(message.timestamp)}</span>
                </div>
                ${replyContent}
                <div class="message-content">${message.content}</div>
                <div class="message-actions">
                    <span class="action-button reply-button" title="Reply">↩</span>
                    ${isSent ? '<span class="action-button delete-button" title="Delete">🗑</span>' : ''}
                </div>
            `;
            
            // Add event listeners for actions
            const replyButton = messageElement.querySelector('.reply-button');
            replyButton.addEventListener('click', () => {
                replyingToMessage = message;
                messageInput.placeholder = `Replying to ${isSent ? 'yourself' : message.senderEmail.split('@')[0]}: ${message.content.substring(0, 30)}${message.content.length > 30 ? '...' : ''}`;
                messageInput.focus();
            });
            
            if (isSent) {
                const deleteButton = messageElement.querySelector('.delete-button');
                deleteButton.addEventListener('click', () => {
                    deleteMessage(messageId);
                });
            }
            
            // Add swipe to reply (simplified for this example)
            messageElement.addEventListener('swipe-right', () => {
                replyingToMessage = message;
                messageInput.placeholder = `Replying to ${isSent ? 'yourself' : message.senderEmail.split('@')[0]}: ${message.content.substring(0, 30)}${message.content.length > 30 ? '...' : ''}`;
                messageInput.focus();
            });
            
            messagesContainer.appendChild(messageElement);
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate();
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Send a message
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;
            
            if (currentChat === 'group') {
                sendGroupMessage(content);
            } else {
                sendPrivateMessage(content);
            }
            
            // Clear input and reset reply
            messageInput.value = '';
            messageInput.placeholder = 'Type a message...';
            replyingToMessage = null;
        }

        // Send message to group chat
        async function sendGroupMessage(content) {
            const messageData = {
                content: content,
                senderId: currentUser.uid,
                senderEmail: currentUser.email,
                senderName: currentUser.displayName || currentUser.email.split('@')[0],
                timestamp: serverTimestamp(),
                deleted: false
            };
            
            if (replyingToMessage) {
                messageData.replyTo = {
                    messageId: replyingToMessage.id,
                    senderId: replyingToMessage.senderId,
                    senderEmail: replyingToMessage.senderEmail,
                    content: replyingToMessage.content
                };
            }
            
            try {
                await addDoc(collection(db, 'conversations', 'group', 'messages'), messageData);
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Send private message
        async function sendPrivateMessage(content) {
            // Determine the conversation ID (sorted user IDs)
            const conversationId = [currentUser.uid, currentChat].sort().join('_');
            
            // Ensure conversation document exists
            const conversationRef = doc(db, 'conversations', conversationId);
            const conversationSnap = await getDoc(conversationRef);
            
            if (!conversationSnap.exists()) {
                await setDoc(conversationRef, {
                    participants: [currentUser.uid, currentChat],
                    createdAt: serverTimestamp()
                });
            }
            
            const messageData = {
                content: content,
                senderId: currentUser.uid,
                senderEmail: currentUser.email,
                senderName: currentUser.displayName || currentUser.email.split('@')[0],
                recipientId: currentChat,
                timestamp: serverTimestamp(),
                deleted: false
            };
            
            if (replyingToMessage) {
                messageData.replyTo = {
                    messageId: replyingToMessage.id,
                    senderId: replyingToMessage.senderId,
                    senderEmail: replyingToMessage.senderEmail,
                    content: replyingToMessage.content
                };
            }
            
            try {
                await addDoc(collection(db, 'conversations', conversationId, 'messages'), messageData);
            } catch (error) {
                console.error('Error sending private message:', error);
            }
        }

        // Delete a message
        async function deleteMessage(messageId) {
            if (currentChat === 'group') {
                // In group chat, mark as deleted but keep the record
                const messageRef = doc(db, 'conversations', 'group', 'messages', messageId);
                await setDoc(messageRef, { deleted: true }, { merge: true });
            } else {
                // In private chat, you might want to actually delete it
                const conversationId = [currentUser.uid, currentChat].sort().join('_');
                const messageRef = doc(db, 'conversations', conversationId, 'messages', messageId);
                await deleteDoc(messageRef);
            }
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
